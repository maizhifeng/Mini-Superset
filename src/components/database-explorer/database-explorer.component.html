<div class="h-full bg-[var(--theme-bg-card)] p-4 rounded-lg border border-[var(--theme-border)] shadow-sm flex flex-col">
  <h3 class="text-lg font-medium text-[var(--theme-text-secondary)] mb-4 flex-shrink-0">ğŸ—‚ï¸ æ•°æ®åº“</h3>
  
  <div class="mb-4 flex-shrink-0 flex flex-col gap-2">
     @switch(databaseService.dbStatus()) {
        @case('ready') {
          <button (click)="uploadModal().open()" class="w-full h-10 px-5 flex items-center justify-center rounded-md font-medium text-sm transition-colors duration-150 ease-in-out focus-visible:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--theme-accent-primary)] bg-[var(--theme-accent-primary)] text-[var(--theme-accent-primary-on)] hover:bg-[var(--theme-accent-primary-hover)] disabled:bg-gray-200 disabled:text-gray-500 disabled:cursor-not-allowed" [disabled]="databaseService.isLoading()">
            @if(databaseService.isLoading()) {
              <span>æ­£åœ¨åŠ è½½...</span>
            } @else {
              <span>+ ä¸Šä¼  CSV</span>
            }
          </button>
          
          <!-- AI Suggestions Button -->
          @if (databaseService.hasSelectedColumns()) {
            <button (click)="getAiSuggestions()" class="w-full h-10 px-5 flex items-center justify-center rounded-md font-medium text-sm transition-colors duration-150 ease-in-out focus-visible:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--theme-bg-card)] focus:ring-[var(--theme-accent-secondary-on-container)] bg-[var(--theme-accent-secondary-container)] text-[var(--theme-accent-secondary-on-container)] hover:bg-emerald-200/80 disabled:bg-gray-200 disabled:text-gray-500 disabled:cursor-not-allowed" [disabled]="aiService.isLoading()">
              @if(aiService.isLoading()) {
                <div class="w-5 h-5 border-2 border-current border-t-transparent rounded-full animate-spin"></div>
                <span class="ml-2">ç”Ÿæˆä¸­...</span>
              } @else {
                <span>âœ¨ è·å–å»ºè®®</span>
              }
            </button>
          }
        }
        @case('initializing') {
            <div class="text-sm text-[var(--theme-text-secondary)] p-2 animate-pulse">æ­£åœ¨åˆå§‹åŒ–... âš™ï¸</div>
        }
        @case('error') {
            <div class="p-2 text-xs text-red-800 bg-red-100 rounded-md">
            åˆå§‹åŒ–å¤±è´¥
            </div>
        }
      }
  </div>

  <div class="flex-grow overflow-y-auto -mr-2 pr-2">
      @if(databaseService.dbStatus() === 'ready') {
          @if (databaseService.tables().length > 0) {
            <!-- PGLite Sample Tables -->
            @if (databaseService.tablesByCategory().pglite.length > 0) {
              <div class="mb-4">
                <h4 class="px-2 text-xs font-semibold uppercase text-[var(--theme-text-secondary)]/70">PGLite ç¤ºä¾‹</h4>
                <ul class="space-y-1 mt-1">
                  @for(table of databaseService.tablesByCategory().pglite; track table.name) {
                    <li>
                      <div class="w-full flex items-center justify-between text-left px-2 py-2 rounded-md hover:bg-gray-100 text-sm font-sans text-[var(--theme-text-primary)]">
                        <div class="flex items-center gap-2 flex-grow overflow-hidden">
                          <input type="checkbox"
                                [id]="'table-cb-' + table.name"
                                [checked]="getTableSelectionState(table.name) === 'all'"
                                [indeterminate]="getTableSelectionState(table.name) === 'some'"
                                (change)="handleTableSelection(table.name)"
                                title="é€‰æ‹©/å–æ¶ˆé€‰æ‹©æ­¤è¡¨ä¸­çš„æ‰€æœ‰åˆ—"
                                class="h-4 w-4 rounded text-[var(--theme-accent-primary)] focus:ring-[var(--theme-accent-primary)] border-[var(--theme-border)] bg-transparent cursor-pointer accent-[var(--theme-accent-primary)]"
                          >
                          <label [for]="'table-cb-' + table.name" (click)="previewTable(table.name, $event)" class="truncate cursor-pointer hover:underline" [title]="'æŸ¥è¯¢ ' + table.name">{{ table.name }}</label>
                        </div>
                        <button (click)="toggleTable(table.name)" class="w-7 h-7 flex items-center justify-center rounded-md transition-colors duration-150 ease-in-out text-[var(--theme-text-secondary)] hover:bg-gray-200 flex-shrink-0 -mr-1" title="å±•å¼€/æŠ˜å åˆ—">
                          <span class="transition-transform text-xs" [class.rotate-90]="expandedTables().has(table.name)">â–¶</span>
                        </button>
                      </div>
                      @if (expandedTables().has(table.name)) {
                        <ul class="pl-4 mt-1 space-y-1">
                          @for(column of table.schema; track column.sanitizedName) {
                            <li class="px-2 py-1.5 text-xs text-[var(--theme-text-secondary)] bg-gray-50 rounded-md font-mono flex justify-between items-center">
                              <label class="flex items-center gap-2 cursor-pointer w-full">
                                <input type="checkbox" 
                                      [checked]="databaseService.isSelected(table.name, column.originalName)" 
                                      (change)="handleColumnSelection(table.name, column)" 
                                      class="h-4 w-4 rounded text-[var(--theme-accent-primary)] focus:ring-[var(--theme-accent-primary)] border-[var(--theme-border)] bg-transparent cursor-pointer accent-[var(--theme-accent-primary)]"
                                >
                                <span class="truncate" [title]="column.sanitizedName">{{ column.sanitizedName }}</span>
                              </label>
                              <span class="text-white bg-gray-400 px-1.5 py-0.5 text-[10px] rounded-md font-sans font-bold flex-shrink-0">{{ column.sqlType }}</span>
                            </li>
                          }
                        </ul>
                      }
                    </li>
                  }
                </ul>
              </div>
            }

            <!-- Uploaded/User Tables -->
            @if (databaseService.tablesByCategory().uploaded.length > 0) {
              <div class="mb-4">
                <h4 class="px-2 text-xs font-semibold uppercase text-[var(--theme-text-secondary)]/70">å·²ä¸Šä¼ ä¸ç”¨æˆ·åˆ›å»º</h4>
                <ul class="space-y-1 mt-1">
                  @for(table of databaseService.tablesByCategory().uploaded; track table.name) {
                    <li>
                      <div class="w-full flex items-center justify-between text-left px-2 py-2 rounded-md hover:bg-gray-100 text-sm font-sans text-[var(--theme-text-primary)]">
                        <div class="flex items-center gap-2 flex-grow overflow-hidden">
                          <input type="checkbox"
                                [id]="'table-cb-' + table.name"
                                [checked]="getTableSelectionState(table.name) === 'all'"
                                [indeterminate]="getTableSelectionState(table.name) === 'some'"
                                (change)="handleTableSelection(table.name)"
                                title="é€‰æ‹©/å–æ¶ˆé€‰æ‹©æ­¤è¡¨ä¸­çš„æ‰€æœ‰åˆ—"
                                class="h-4 w-4 rounded text-[var(--theme-accent-primary)] focus:ring-[var(--theme-accent-primary)] border-[var(--theme-border)] bg-transparent cursor-pointer accent-[var(--theme-accent-primary)]"
                          >
                          <label [for]="'table-cb-' + table.name" (click)="previewTable(table.name, $event)" class="truncate cursor-pointer hover:underline" [title]="'æŸ¥è¯¢ ' + table.name">{{ table.name }}</label>
                        </div>
                        <button (click)="toggleTable(table.name)" class="w-7 h-7 flex items-center justify-center rounded-md transition-colors duration-150 ease-in-out text-[var(--theme-text-secondary)] hover:bg-gray-200 flex-shrink-0 -mr-1" title="å±•å¼€/æŠ˜å åˆ—">
                          <span class="transition-transform text-xs" [class.rotate-90]="expandedTables().has(table.name)">â–¶</span>
                        </button>
                      </div>
                      @if (expandedTables().has(table.name)) {
                        <ul class="pl-4 mt-1 space-y-1">
                          @for(column of table.schema; track column.sanitizedName) {
                            <li class="px-2 py-1.5 text-xs text-[var(--theme-text-secondary)] bg-gray-50 rounded-md font-mono flex justify-between items-center">
                              <label class="flex items-center gap-2 cursor-pointer w-full">
                                <input type="checkbox" 
                                      [checked]="databaseService.isSelected(table.name, column.originalName)" 
                                      (change)="handleColumnSelection(table.name, column)" 
                                      class="h-4 w-4 rounded text-[var(--theme-accent-primary)] focus:ring-[var(--theme-accent-primary)] border-[var(--theme-border)] bg-transparent cursor-pointer accent-[var(--theme-accent-primary)]"
                                >
                                <span class="truncate" [title]="column.sanitizedName">{{ column.sanitizedName }}</span>
                              </label>
                              <span class="text-white bg-gray-400 px-1.5 py-0.5 text-[10px] rounded-md font-sans font-bold flex-shrink-0">{{ column.sqlType }}</span>
                            </li>
                          }
                        </ul>
                      }
                    </li>
                  }
                </ul>
              </div>
            }

          } @else if (!databaseService.isLoading()) {
              <p class="px-3 text-xs text-[var(--theme-text-secondary)]">æ²¡æœ‰å¯ç”¨çš„è¡¨ã€‚</p>
          }
      }
  </div>
  <app-file-upload-modal #modalInstance />
  <app-sql-suggestions-modal #suggestionsModalInstance />
</div>