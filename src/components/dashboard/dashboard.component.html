<div class="flex flex-col gap-6">
  <!-- Global Filter -->
  @if(dashboardService.availableRegions().length > 0) {
    <div class="bg-[var(--theme-bg-card)] p-4 rounded-xl shadow-sm border border-[var(--theme-border)] flex items-center gap-4 animate-fade-in-down">
      <label for="region-filter" class="text-sm font-medium text-[var(--theme-text-secondary)] flex-shrink-0">ğŸ—ºï¸ åœ°åŒºç­›é€‰:</label>
      <div class="relative flex-grow max-w-xs">
          <select id="region-filter" (change)="onFilterChange($event)" class="w-full bg-transparent border border-[var(--theme-border)] rounded-md pl-3 pr-8 py-2 text-sm focus:ring-2 focus:ring-[var(--theme-accent-primary)] focus:border-[var(--theme-accent-primary)] outline-none appearance-none cursor-pointer">
              <option value="">æ‰€æœ‰åœ°åŒº</option>
              @for (region of dashboardService.availableRegions(); track region) {
                  <option [value]="region">{{ region }}</option>
              }
          </select>
          <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-[var(--theme-text-secondary)]">
              <span>â–¾</span>
          </div>
      </div>
    </div>
  }

  <!-- KPI Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
    @for (card of dashboardService.kpiCards(); track card.id) {
      <div 
        class="bg-[var(--theme-bg-card)] p-6 rounded-xl shadow-sm flex flex-col border transition-all duration-300 ease-in-out overflow-hidden"
        [class.border-[var(--theme-border)]]="!card.error"
        [class.border-red-300]="card.error"
        [class.bg-red-50/30]="card.error"
        [class.opacity-75]="card.isLoading"
        [class.cursor-pointer]="!card.isLoading && !card.error"
        [class.hover:shadow-lg]="!card.isLoading && !card.error"
        [class.hover:-translate-y-1]="!card.isLoading && !card.error"
        [class.hover:border-indigo-300]="!card.isLoading && !card.error"
        [class.h-48]="hoveredCardId() === card.id && !card.isLoading && !card.error"
        [class.h-28]="hoveredCardId() !== card.id || card.isLoading || card.error"
        (mouseenter)="setHoveredCard(card.id)"
        (mouseleave)="setHoveredCard(null)"
        (click)="drillDown(card)">
        
        <!-- Primary Content -->
        <div class="flex items-start flex-shrink-0">
            <div class="p-3 rounded-lg transition-colors"
              [class.bg-indigo-100]="!card.error"
              [class.bg-red-100]="card.error">
                <span class="text-2xl transition-colors"
                  [class.text-red-600]="card.error">{{ card.icon }}</span>
            </div>
            <div class="ml-4">
                <p class="text-sm text-[var(--theme-text-secondary)]">{{ card.title }}</p>
                @if(card.isLoading) {
                  <div class="mt-1 w-24 h-7 bg-gray-200 rounded animate-pulse"></div>
                } @else if (card.error) {
                  <p class="text-lg font-bold text-red-600" [title]="card.error">é”™è¯¯</p>
                } @else {
                  <p class="text-2xl font-bold text-[var(--theme-text-primary)]">
                    @switch(card.format) {
                      @case('currency') { {{ card.primaryValue | currency:'USD':'symbol':'1.0-0' }} }
                      @case('number') { {{ card.primaryValue | number }} }
                      @default { {{ card.primaryValue | number }} }
                    }
                  </p>
                }
            </div>
        </div>

        <!-- Secondary (Hover) Content -->
        <div class="flex-grow mt-4 pt-3 border-t border-[var(--theme-border)]">
          <p class="text-xs font-semibold text-[var(--theme-text-secondary)] uppercase tracking-wider">{{ card.secondaryTitle }}</p>
          <ul class="mt-1 space-y-0.5">
            @for(item of card.secondaryData; track item.label) {
              <li class="flex justify-between text-sm text-[var(--theme-text-secondary)]">
                <span class="truncate" [title]="item.label">{{ item.label }}</span>
                <span class="font-medium text-[var(--theme-text-primary)] flex-shrink-0">
                  @switch(card.format) {
                    @case('currency') { {{ item.value | currency:'USD':'symbol':'1.0-0' }} }
                    @case('number') { {{ item.value | number }} }
                    @default { {{ item.value | number }} }
                  }
                </span>
              </li>
            }
            @if(card.secondaryData.length === 0 && !card.isLoading) {
              <li class="text-sm text-center text-gray-400 italic mt-1">æ— æ•°æ®</li>
            }
          </ul>
        </div>
      </div>
    }
  </div>

  <!-- Charts Area -->
  @if (dashboardService.displayableCharts().length > 0) {
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
      @for (chart of dashboardService.displayableCharts(); track chart.id) {
        <div class="bg-[var(--theme-bg-card)] rounded-lg shadow-sm border border-[var(--theme-border)] p-4 flex flex-col transition-all hover:shadow-lg hover:-translate-y-1 cursor-pointer">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-base font-medium text-[var(--theme-text-secondary)] truncate" [title]="chart.title">
              {{ chart.title }}
            </h3>
            <button (click)="dashboardService.removeChart(chart.id)" title="ç§»é™¤å›¾è¡¨" class="w-8 h-8 flex items-center justify-center rounded-full transition-colors duration-150 ease-in-out text-[var(--theme-text-secondary)] hover:bg-red-100 hover:text-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
              ğŸ—‘ï¸
            </button>
          </div>
          <div class="flex-grow min-h-[300px] relative">
            <app-chart [config]="chart"></app-chart>
          </div>
        </div>
      }
    </div>
  } @else {
    <div class="text-center p-8 bg-[var(--theme-bg-card)] rounded-lg shadow-sm border border-[var(--theme-border)]">
        <h2 class="text-2xl font-semibold text-[var(--theme-text-primary)] mb-2">ä»ªè¡¨æ¿ä¸ºç©º ğŸ“Š</h2>
        <p class="text-[var(--theme-text-secondary)] max-w-xl mx-auto">
            å‰å¾€ <span class="font-semibold text-[var(--theme-accent-primary)]">SQL å·¥ä½œå°</span>ï¼Œè¿è¡ŒæŸ¥è¯¢ï¼Œåˆ‡æ¢åˆ°<span class="font-semibold text-[var(--theme-accent-primary)]">å›¾è¡¨</span>é€‰é¡¹å¡ï¼Œç„¶åç‚¹å‡»<span class="font-semibold text-[var(--theme-accent-primary)]">ğŸ“Œ å›ºå®š</span>æŒ‰é’®å°†å›¾è¡¨æ·»åŠ åˆ°è¿™é‡Œã€‚
        </p>
    </div>
  }
</div>